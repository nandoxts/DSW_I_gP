@model List<Proy_DSWI_NinaJose.Models.Carrito>
@{
    ViewData["Title"] = "Tu Carrito";
    Layout = "_Layout";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-cart4 me-2"></i>@ViewData["Title"]</h2>
        <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
            <i class="bi bi-arrow-left-circle me-1"></i>Volver
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-cart-x" style="font-size: 4rem;"></i>
                    <p class="mt-3 fs-5">Tu carrito está vacío.</p>
                    <button type="button" class="btn btn-primary" onclick="goBack()">
                        Seguir comprando
                    </button>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Imagen</th>
                                <th>Producto</th>
                                <th class="text-end">Precio</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cart-body">
                            @foreach (var item in Model)
                            {
                                <tr data-id="@item.ProductoId">
                                    <td style="width: 80px;">
                                        <img src="@item.ImagenUrl" class="img-fluid rounded"
                                             onerror="this.onerror=null;this.src='/images/no-image.png';" />
                                    </td>
                                    <td>@item.Nombre</td>
                                    <td class="text-end price-cell">S/ @item.Precio.ToString("F2")</td>
                                    <td class="text-center">
                                        <div class="input-group input-group-sm justify-content-center">
                                            <input type="number" value="@item.Cantidad" min="1"
                                                   class="form-control cart-qty-input"
                                                   style="max-width: 80px;" />
                                            <button type="button"
                                                    class="btn btn-outline-secondary cart-update-btn"
                                                    title="Actualizar cantidad">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="text-end subtotal-cell">
                                        S/ @item.Subtotal.ToString("F2")
                                    </td>
                                    <td class="text-center">
                                        <button type="button"
                                                class="btn btn-sm btn-danger cart-remove-btn"
                                                title="Eliminar del carrito">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        @if (Model.Any())
        {
            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                <div>
                    <strong>Total:</strong>
                    <span id="cart-total" class="fs-5">
                        S/ @Model.Sum(i => i.Subtotal).ToString("F2")
                    </span>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="goBack()">
                        Seguir comprando
                    </button>

                    @* Aquí hacemos POST a CheckoutPost *@
                    <form asp-controller="Orden"
                          asp-action="CheckoutPost"
                          method="post"
                          class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-success">
                            Pagar ahora
                        </button>
                    </form>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Volver atrás o a catálogo
        function goBack() {
            if (window.history.length > 1) window.history.back();
            else window.location.href = '@Url.Action("IndexProductos", "Producto")';
        }

        document.addEventListener('click', function (e) {
            // =========================
            // 1) ACTUALIZAR CANTIDAD
            // =========================
            var updateBtn = e.target.closest('.cart-update-btn');
            if (updateBtn) {
                var row = updateBtn.closest('tr[data-id]');
                var id = row.getAttribute('data-id');
                var qtyInput = row.querySelector('.cart-qty-input');
                var cantidad = qtyInput.value;

                // Token antiforgery
                var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
                var token = tokenEl ? tokenEl.value : '';

                // Prepara FormData
                var data = new FormData();
                data.append('__RequestVerificationToken', token);
                data.append('id', id);
                data.append('cantidad', cantidad);

                // Llama a Carrito/UpdateQuantity
                fetch('@Url.Action("UpdateQuantity", "Carrito")', {
                    method: 'POST',
                    body: data
                })
                    .then(function (res) {
                        if (!res.ok) {
                            return res.text().then(function (txt) { throw new Error(txt); });
                        }
                        return res.json();
                    })
                    .then(function (json) {
                        // Actualiza badge global
                        var badge = document.getElementById('cartCountBadge');
                        if (badge) badge.textContent = json.newCount;
                        // Actualiza subtotal de esta fila
                        var subCell = row.querySelector('.subtotal-cell');
                        subCell.textContent = 'S/ ' + json.newSubtotal.toFixed(2);
                        // Actualiza total general
                        var totalEl = document.getElementById('cart-total');
                        totalEl.textContent = 'S/ ' + json.newTotal.toFixed(2);
                    })
                    .catch(function (err) {
                        console.error(err);
                        alert('Error al actualizar cantidad: ' + err.message);
                    });

                return;
            }

            // =========================
            // 2) ELIMINAR PRODUCTO
            // =========================
            var removeBtn = e.target.closest('.cart-remove-btn');
            if (removeBtn) {
                var row = removeBtn.closest('tr[data-id]');
                var id = row.getAttribute('data-id');

                // Token antiforgery
                var tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
                var token = tokenEl ? tokenEl.value : '';

                // Prepara FormData
                var data = new FormData();
                data.append('__RequestVerificationToken', token);
                data.append('id', id);

                // Llama a Carrito/RemoveFromCart
                fetch('@Url.Action("RemoveFromCart", "Carrito")', {
                    method: 'POST',
                    body: data
                })
                    .then(function (res) {
                        if (!res.ok) {
                            return res.text().then(function (txt) { throw new Error(txt); });
                        }
                        return res.json();
                    })
                    .then(function (json) {
                        // Actualiza badge global
                        var badge = document.getElementById('cartCountBadge');
                        if (badge) badge.textContent = json.newCount;
                        // Elimina la fila del DOM
                        row.parentNode.removeChild(row);
                        // Actualiza total general
                        var totalEl = document.getElementById('cart-total');
                        totalEl.textContent = 'S/ ' + json.newTotal.toFixed(2);

                        // Si queda vacío, recarga la página o muestra mensaje vacío
                        if (json.newCount === 0) {
                            location.reload();
                        }
                    })
                    .catch(function (err) {
                        console.error(err);
                        alert('Error al eliminar producto: ' + err.message);
                    });

                return;
            }
        });
    </script>
}

