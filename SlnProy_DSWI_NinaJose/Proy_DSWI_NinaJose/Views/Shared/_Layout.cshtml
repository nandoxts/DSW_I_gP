@using Proy_DSWI_NinaJose.Extensions
@using Proy_DSWI_NinaJose.Models
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    // Inicializa el contador del carrito desde la sesión
    var sessionCart = Context.Session
        .GetObject<List<Carrito>>("Carrito")
        ?? new List<Carrito>();
    var initialCount = sessionCart.Sum(c => c.Cantidad);
    var ctrl = ViewContext.RouteData.Values["Controller"]?.ToString();
    var act = ViewContext.RouteData.Values["Action"]?.ToString();
    bool enCarrito = string.Equals(ctrl, "Carrito", System.StringComparison.OrdinalIgnoreCase)
                  && string.Equals(act, "IndexCarrito", System.StringComparison.OrdinalIgnoreCase);
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] – MiTienda</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-3">
        <div class="container">
            <a class="navbar-brand" asp-controller="Home" asp-action="Index">MiTienda</a>
            <button class="navbar-toggler" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto align-items-center">
                    @if (!User.Identity.IsAuthenticated)
                    {
                        <li class="nav-item me-2">
                            <button class="btn btn-outline-primary" onclick="showLoginModal()">Iniciar sesión</button>
                        </li>
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary" onclick="showRegisterModal()">Registrarse</button>
                        </li>
                    }
                    else
                    {
                        @if (User.IsInRole("Cliente") && !enCarrito)
                        {
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-success position-relative"
                                   asp-controller="Carrito"
                                   asp-action="IndexCarrito">
                                    <i class="bi bi-cart-fill fs-4"></i>
                                    <span id="cartCountBadge"
                                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        @initialCount
                                    </span>
                                </a>
                            </li>
                        }
                        <li class="nav-item dropdown">
                            <button class="btn btn-link nav-link fs-4 p-0"
                                    id="settingsDropdown"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <i class="bi bi-gear-fill"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="settingsDropdown">
                                <li>
                                    <button class="dropdown-item d-flex align-items-center" onclick="showProfile()">
                                        <i class="bi bi-person-circle me-2"></i>Mi perfil
                                    </button>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="dropdown-item d-flex align-items-center">
                                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        @RenderBody()
    </div>

    <div id="addCartAlert"
         class="alert alert-success position-fixed top-0 end-0 m-3 py-2 px-3 d-none"
         role="alert">
        Producto añadido al carrito
    </div>

    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detallesModalLabel">Detalles del producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="perfilModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mi Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="perfilModalBody"></div>
            </div>
        </div>
    </div>

    <!-- Modal Login -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Iniciar sesión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="loginErrors" class="text-danger mb-3"></div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input id="loginEmail" name="Email" type="email" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input id="loginPassword" name="Password" type="password" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-link p-0" onclick="showRegisterModal()">Regístrate</button>
                    <button id="btnLogin" class="btn btn-primary">Ingresar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrarse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="regErrors" class="text-danger mb-3"></div>
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input id="regNombre" type="text" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input id="regEmail" type="email" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input id="regPassword" type="password" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Contraseña</label>
                        <input id="regConfirm" type="password" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btnRegister" class="btn btn-success">Crear cuenta</button>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function closeAllModals() {
            document.querySelectorAll('.modal.show').forEach(el => {
                bootstrap.Modal.getInstance(el)?.hide();
            });
        }

        function showDetails(url) {
            closeAllModals();
            fetch(url)
                .then(r => r.ok ? r.text() : Promise.reject())
                .then(html => {
                    document.querySelector('#detallesModal .modal-body').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('detallesModal')).show();
                })
                .catch(console.error);
        }

        function updateBadge(count) {
            $('#cartCountBadge').text(count);
        }

        function flashAddedAlert() {
            $('#addCartAlert').removeClass('d-none');
            setTimeout(() => $('#addCartAlert').addClass('d-none'), 2000);
        }

        $(document).on('click', '.index-add-btn', function () {
            const id = $(this).data('id');
            const token = $('input[name="__RequestVerificationToken"]').first().val();
            $.post('@Url.Action("AddToCart", "Carrito")', {
                __RequestVerificationToken: token, id: id, cantidad: 1
            })
                .done(res => {
                    updateBadge(res.newCount);
                    flashAddedAlert();
                })
                .fail(() => alert('Error al añadir al carrito.'));
        });

        $(document).on('click', '#detailAddBtn', function () {
            const id = $(this).data('id');
            const qty = $('#detailQty').val();
            const token = $('input[name="__RequestVerificationToken"]').first().val();
            $.post('@Url.Action("AddToCart", "Carrito")', {
                __RequestVerificationToken: token, id: id, cantidad: qty
            })
                .done(res => {
                    updateBadge(res.newCount);
                    closeAllModals();
                    flashAddedAlert();
                })
                .fail(() => alert('Error al añadir al carrito.'));
        });

        $(document).on('click', '.cart-update-btn', function () {
            const row = $(this).closest('tr');
            const id = row.data('id');
            const qty = row.find('.cart-qty-input').val();
            const token = $('input[name="__RequestVerificationToken"]').first().val();
            $.post('@Url.Action("UpdateQuantity", "Carrito")', {
                __RequestVerificationToken: token, id: id, cantidad: qty
            })
                .done(res => {
                    row.find('.subtotal-cell').text('S/ ' + res.newSubtotal.toFixed(2));
                    $('#cartTotal').text('S/ ' + res.newTotal.toFixed(2));
                    updateBadge(res.newCount);
                })
                .fail(() => alert('Error al actualizar.'));
        });

        $(document).on('click', '.cart-remove-btn', function () {
            const row = $(this).closest('tr');
            const id = row.data('id');
            const token = $('input[name="__RequestVerificationToken"]').first().val();
            $.post('@Url.Action("RemoveFromCart", "Carrito")', {
                __RequestVerificationToken: token, id: id
            })
                .done(res => {
                    row.remove();
                    $('#cartTotal').text('S/ ' + res.newTotal.toFixed(2));
                    updateBadge(res.newCount);
                })
                .fail(() => alert('Error al eliminar.'));
        });

        function showLoginModal() {
            closeAllModals();
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }
        function showRegisterModal() {
            closeAllModals();
            new bootstrap.Modal(document.getElementById('registerModal')).show();
        }
        function showProfile() {
            closeAllModals();
            const modal = new bootstrap.Modal(document.getElementById('perfilModal'));
            fetch('@Url.Action("Profile", "Profile")')
                .then(r => r.ok ? r.text() : Promise.reject())
                .then(html => {
                    document.getElementById('perfilModalBody').innerHTML = html;
                    modal.show();
                })
                .catch(console.error);
        }
    </script>
    <script>
        $('#btnLogin').click(function () {
            const email = $('#loginEmail').val();
            const pwd = $('#loginPassword').val();

            // Envía por AJAX al endpoint Account/Login
            $.post('@Url.Action("Login", "Account")',
                {
                    Email: email,
                    Password: pwd
                })
                .done(res => {
                    if (res.success) {
                        location.reload();      // Login OK: recarga para actualizar estado
                    } else {
                        // Respuesta con errores: lista de strings en res.errors
                        $('#loginErrors').html(res.errors.join('<br>'));
                    }
                })
                .fail(() => {
                    $('#loginErrors').text('Error en el servidor.');
                });
        });
    </script>


    @RenderSection("Scripts", required: false)
</body>
</html>
